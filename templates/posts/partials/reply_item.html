{% load static %}
{% load posts_extras %}  <!-- CARREGAR O TEMPLATE FILTER -->

<div class="reply-item" id="reply-{{ reply.id }}">
    <div class="reply-author">
        <div class="author-info">
            <div class="username">
                <a href="{% url 'perfil' username=reply.autor.username %}">
                    {{ reply.autor.username }}
                </a>
            </div>
            <div class="user-role">{{ reply.autor.apelido|default:"Membro" }}</div>
        </div>

        <div class="author-avatar">
            {% if reply.autor.avatar %}
                <img src="{{ reply.autor.avatar.url }}" alt="Avatar" class="user-avatar">
            {% else %}
                <img src="{% static 'images/default-avatar.png' %}" alt="Default Avatar" class="user-avatar">
            {% endif %}
        </div>

        <div class="author-stats">
            <div>Posts: <u>{{ reply.autor.total_itens|default:"0" }}</u></div>
            <div>Respostas: <u>{{ reply.autor.answers|default:"0" }}</u></div>
            <div>Reputação: <u>{{ reply.autor.reputacao|default:"0" }}</u></div>
        </div>
    </div>

    <div class="reply-content-wrapper">
        <div class="reply-content">
            {{ reply.conteudo|linebreaks }}
        </div>

        <!-- Reações da resposta -->
        {% if user.is_authenticated %}
        <div class="reactions-container" data-type="reply" data-target-id="{{ reply.id }}">
            <div class="reactions-summary">
                {% for reacao in reply.reacoes_summary %}
                    {% if reacao.count > 0 %}
                    <div class="reaction-summary-item">
                        <img src="{{ reacao.reacao__icone.url }}" alt="{{ reacao.reacao__nome }}" class="reaction-icon-small">
                        <span class="reaction-count-small">{{ reacao.count }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <button class="reaction-btn{% if user_reactions_replies|get_item:reply.id %} has-reaction{% endif %}"
                    {% with user_reaction=user_reactions_replies|get_item:reply.id %}
                        {% if user_reaction %}data-user-reaction="{{ user_reaction.reacao.id }}"{% endif %}
                    {% endwith %}>                
                <i class="fa fa-smile-o"></i>
                {% with total_reactions=reply.reacoes_summary|length %}
                <span class="reaction-count{% if not total_reactions %} d-none{% endif %}">
                    {{ total_reactions }}
                </span>
                {% endwith %}
            </button>
            
            <div class="reactions-dropdown">
                <div class="reactions-grid">
                    {% for reacao in reacoes_disponiveis %}
                    <div class="reaction-option" 
                         data-reacao-id="{{ reacao.id }}"
                         title="{{ reacao.nome }}">
                        <img src="{{ reacao.icone.url }}" alt="{{ reacao.nome }}" class="reaction-icon">
                        <span class="reaction-name">{{ reacao.nome }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>